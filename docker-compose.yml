version: '3.8'

services:
  ms-websocket:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ms-websocket
    ports:
      - "4004:3000"
    environment:
      # Application
      - NODE_ENV=development
      - APP_NAME=MS-WebSocket
      - APP_PORT=3000
      - APP_HOST=0.0.0.0

      # Logging
      - LOG_LEVEL=info
      - LOG_FORMAT=pretty

      # Redis - Usando BD local de la máquina host
      # PostgreSQL o SQL Server también disponibles si las tienes instaladas
      - REDIS_HOST=host.docker.internal
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      - REDIS_DB=0

      # JWT
      - JWT_SECRET=your-super-secret-jwt-key-change-in-production
      - JWT_EXPIRATION=24h

      # CORS
      - CORS_ORIGIN=http://localhost:3000,http://localhost:3001,http://localhost:4004,http://localhost:8000,http://localhost:8001,http://localhost:8002,http://localhost:8003

      # Microservices URLs (apuntan a host local)
      - MS_AUTH_URL=http://host.docker.internal:8000
      - MS_AUTH_VERIFY_ENDPOINT=/graphql
      - MS_AUTH_TIMEOUT=10000

      - MS_DESPACHO_URL=http://host.docker.internal:8001
      - MS_DESPACHO_API_ENDPOINT=/api/v1

      - MS_DECISION_URL=http://host.docker.internal:8002
      - MS_DECISION_ENDPOINT=/api

      # WebSocket Configuration
      - WS_HEARTBEAT_INTERVAL=30000
      - WS_HEARTBEAT_TIMEOUT=5000
      - WS_RECONNECTION_DELAY=1000
      - WS_MAX_RECONNECTION_ATTEMPTS=5

      # GraphQL
      - GRAPHQL_ENABLED=true
      - GRAPHQL_ENDPOINT=/graphql
      - GRAPHQL_PLAYGROUND=true

      # Health Check
      - HEALTH_CHECK_INTERVAL=30000
      - HEALTH_CHECK_ENABLED=true

      # Rate Limiting
      - RATE_LIMIT_ENABLED=true
      - RATE_LIMIT_WINDOW_MS=60000
      - RATE_LIMIT_MAX_REQUESTS=100

      # Security
      - HELMET_ENABLED=true
      - SECURE_HEADERS_ENABLED=true

      # Metrics
      - METRICS_ENABLED=true
      - METRICS_PORT=9090
      - METRICS_ENDPOINT=/metrics

    restart: unless-stopped
    network_mode: host
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    # Volumen para logs (opcional)
    volumes:
      - ./logs:/app/logs

networks:
  default:
    name: swii-network
    driver: bridge
